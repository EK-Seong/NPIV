% NPIV Monte-Carlo simulation.
% The DGP is the dataset provided by Horowitz(2011a)
% I want to illustrate the vulnerability of NPIV in the finite sample setting.
% And plan to show that the model averaging can make better performance under
% finite sample.
%
% This file is for drawing the 'Vulnerability' graph.
%

data = importdata('Fig2.xlsx');
dataset = data.data;

%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% Population g(X), beta_iv, beta_ols %%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

n_p = 1552;
population = dataset;
Y = population(:,1);
X = population(:,2);
Z = population(:,3);
K = 3;

% Transform X and Z to Unit Interval
minx = min(X);
rangeX = max(X) - minx;
minz = min(Z);
rangeZ = max(Z) - minz;
X = (X - minx) ./ rangeX;
Z = (Z - minz) ./ rangeZ;

% define a Legendre polynomial basis for L2[0,1]

MX = zeros(n_p,K);
for i=1:K
    if i == 1
        MX(:,i) = ones(n_p,1);
    elseif mod(i,2) == 0
        MX(:,i) = sqrt(2)*sin(floor((i)/2)*(X.*2*pi));
    else
        MX(:,i) = sqrt(2)*cos(floor((i)/2)*(X.*2*pi));
    end
end

MZ = zeros(n_p,K);
for i=1:K
    if i == 1
        MZ(:,i) = ones(n_p,1);
    elseif mod(i,2) == 0
        MZ(:,i) = sqrt(2)*sin(floor((i)/2)*(Z.*2*pi));
    else
        MZ(:,i) = sqrt(2)*cos(floor((i)/2)*(Z.*2*pi));
    end
end

G = (MZ'*MX)\(MZ'*Y);   % Fourier coefficients
g_true = MX*G;          % true g(X)

Xmat = [ones(n_p,1),X]; % X and Z matrices for parametric IV estimation
Zmat = [ones(n_p,1),Z];
betaIV0 = (Zmat'*Xmat)\(Zmat'*Y);
Y_IV0 = Xmat*betaIV0;
beta0 = (Xmat'*Xmat)\(Xmat'*Y);
Y_OLS0 = Xmat*beta0;

population = [population,g_true,Y_IV0];     % population matrix  

figure
plot(X,g_true,'.',X,Y_IV0,'.',X,Y_OLS0,'.',X,Y,'.')
legend 'NPIV' 'IV' 'OLS' 'obs'
ylim([-0.1,0.6])

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% Monte-Carlo Simulation : n = 200 %%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
rng("default")
rep = 50;    % number of repetition
n = 5000;    % number of obs.

K = 2;  % truncation parameter - should be dependent on the data. For now I just fix it.

for r = 1:rep
    
    D = datasample(dataset,n,1,"Replace",true);     % Simulation sample
    Y = D(:,1);
    X = D(:,2);
    Z = D(:,3);
    
    % Transform X and Z to Unit Interval
    minx = min(X);
    rangeX = max(X) - minx;
    minz = min(Z);
    rangeZ = max(Z) - minz;
    X = (X - minx) ./ rangeX;
    Z = (Z - minz) ./ rangeZ;
    
    % define a Legendre polynomial basis for L2[0,1]

    MX = zeros(n,K);
    for i=1:K
        if i == 1
            MX(:,i) = ones(n,1);
        elseif mod(i,2) == 0
            MX(:,i) = sqrt(2)*sin(floor((i)/2)*(X.*2*pi));
        else
            MX(:,i) = sqrt(2)*cos(floor((i)/2)*(X.*2*pi));
        end
    end
    
    MZ = zeros(n,K);
    for i=1:K
        if i == 1
            MZ(:,i) = ones(n,1);
        elseif mod(i,2) == 0
            MZ(:,i) = sqrt(2)*sin(floor((i)/2)*(Z.*2*pi));
        else
            MZ(:,i) = sqrt(2)*cos(floor((i)/2)*(Z.*2*pi));
        end
    end
    
    % NPIV estimate
    G_hat = (MZ'*MX)\(MZ'*Y);
    g_fit = MX*G_hat;
    
    % IV estimation
    Xmat = [ones(n,1),X];   % X and Z matrices for IV estimation
    Zmat = [ones(n,1),Z];
    betaIV = (Zmat'*Xmat)\(Zmat'*Y);
    Y_IV = Xmat*betaIV;

    % plotting the NPIV estimates
    figure(4), hold on
    plot(D(:,2),g_fit,'b.', ...
        population(:,2),population(:,4),'.r')
    ylim([-0.1,0.6])

%     % plotting the IV fitted values  
%     figure(8), hold on
%     plot(D(:,2),Y_IV,'b.', ...
%         population(:,2),population(:,5),'.r')
%     ylim([-0.1,0.6])

end



